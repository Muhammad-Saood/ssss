<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Professional Python Code Runner with Dynamic Tabs (Piston API)</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/dracula.min.css" />
    <style>
      body { background-color: #f8f9fa; }
      .container { max-width: 1200px; margin-top: 20px; }
      .editor-container { border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px; }
      .output-container { background-color: #282a36; color: #f8f8f2; padding: 15px; border-radius: 5px; min-height: 150px; font-family: 'Courier New', monospace; white-space: pre-wrap; overflow: auto; }
      .run-btn { background-color: #28a745; border: none; }
      .run-btn:hover { background-color: #218838; }
      .run-btn:disabled { background-color: #6c757d; }
      .cm-editor { border-radius: 5px; min-height: 300px; }
      .tab-content > .tab-pane { padding: 15px; background-color: #fff; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 5px 5px; }
      .nav-tabs { flex-wrap: nowrap; }
      .nav-item .nav-link.editable { cursor: pointer; }
      .nav-item .add-tab { cursor: pointer; margin-left: 5px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center mb-4">Professional Python Code Runner with Dynamic Tabs</h1>
      <p class="text-center text-muted mb-4">Run Python code using Piston API (free, 500+ executions/day).</p>

      <!-- Tabs Navigation -->
      <ul class="nav nav-tabs" id="codeTabs" role="tablist">
        <!-- Tabs will be added dynamically -->
      </ul>

      <!-- Tabs Content -->
      <div class="tab-content" id="codeTabsContent">
        <!-- Tab panes will be added dynamically -->
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/python/python.min.js"></script>
    <script>
      const maxTabs = 20;
      let tabCount = 0;
      const editors = {};

      const API_URL = "https://emkc.org/api/v2/piston/execute"; // Piston API, no key needed

      function addTab(tabName = "Untitled") {
        if (tabCount >= maxTabs) {
          alert("Maximum of 20 tabs reached.");
          return;
        }

        tabCount++;
        const tabId = `tab${tabCount}`;

        // Add tab navigation item
        const tabNav = document.createElement('li');
        tabNav.className = 'nav-item';
        tabNav.role = 'presentation';
        tabNav.innerHTML = `
          <button class="nav-link editable ${tabCount === 1 ? 'active' : ''}" id="${tabId}-tab" data-bs-toggle="tab" data-bs-target="#${tabId}" type="button" role="tab" aria-controls="${tabId}" aria-selected="${tabCount === 1 ? 'true' : 'false'}">${tabName}</button>
        `;
        document.getElementById('codeTabs').insertBefore(tabNav, document.getElementById('addTabBtn'));

        // Add tab content pane
        const tabPane = document.createElement('div');
        tabPane.className = `tab-pane fade ${tabCount === 1 ? 'show active' : ''}`;
        tabPane.id = tabId;
        tabPane.role = 'tabpanel';
        tabPane.innerHTML = `
          <div class="editor-container mb-3">
            <textarea id="code${tabId}"></textarea>
          </div>
          <button id="run-btn${tabId}" class="btn btn-success run-btn mb-3" onclick="runCode('${tabId}')">Run Code</button>
          <div><h5>Output:</h5><div id="output${tabId}" class="output-container"></div></div>
        `;
        document.getElementById('codeTabsContent').appendChild(tabPane);

        // Initialize CodeMirror for the new tab
        const codeTextarea = document.getElementById(`code${tabId}`);
        editors[tabId] = CodeMirror.fromTextArea(codeTextarea, {
          mode: "python",
          theme: "dracula",
          lineNumbers: true,
          indentUnit: 4,
          matchBrackets: true,
        });

        // Make tab name editable on double-click
        const tabLink = document.getElementById(`${tabId}-tab`);
        tabLink.addEventListener('dblclick', function() {
          const newName = prompt("Edit tab name:", tabLink.textContent);
          if (newName) tabLink.textContent = newName;
        });

        // Activate the new tab if it's the only one or user clicked +
        if (tabCount === 1) {
          new bootstrap.Tab(tabLink).show();
        }

        // Move + button to the end
        updateAddTabBtn();
      }

      function updateAddTabBtn() {
        let addBtn = document.getElementById('addTabBtn');
        if (!addBtn) {
          addBtn = document.createElement('li');
          addBtn.id = 'addTabBtn';
          addBtn.className = 'nav-item';
          addBtn.innerHTML = '<button class="nav-link add-tab">+</button>';
          addBtn.querySelector('.add-tab').addEventListener('click', addTab);
          document.getElementById('codeTabs').appendChild(addBtn);
        } else {
          document.getElementById('codeTabs').appendChild(addBtn);
        }
      }

      // Initialize with one tab
      addTab();

      async function runCode(tabId) {
        const editor = editors[tabId];
        const output = document.getElementById(`output${tabId}`);
        const runBtn = document.getElementById(`run-btn${tabId}`);

        output.textContent = "Running...\n";
        runBtn.disabled = true;
        runBtn.textContent = "Running...";

        const code = editor.getValue();

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              language: "python",
              version: "3.10",
              files: [{ name: "index.py", content: code }],
            }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API request failed: ${response.status} - ${errorText}`);
          }

          const result = await response.json();

          output.textContent = "";
          if (result.run) {
            if (result.run.stdout) output.textContent += `${result.run.stdout}\n`;
            if (result.run.stderr) output.textContent += `${result.run.stderr}\n`;
          } else {
            output.textContent += `${result.message || "Unknown error"}\n`;
          }
        } catch (err) {
          output.textContent += `Error: ${err.message}\n`;
          output.textContent += `Troubleshooting:\n- Check internet connection.\n- Try again (Piston supports 500+/day).\n- Ensure valid Python code.\n`;
        } finally {
          runBtn.disabled = false;
          runBtn.textContent = "Run Code";
        }
      }
    </script>
  </body>
</html>
